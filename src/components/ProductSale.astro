---
import Lightbox from './Lightbox.astro';
import { parseSizes, formatSizesForDisplay } from '../utils/sizes';

const { product } = Astro.props;

// Apply the 20% discount to the product price
const salePrice = (product.price * 0.8).toFixed(2);

const formattedSizes = formatSizesForDisplay(product.sizes, product.productType);
let sizeOptions = parseSizes(product.sizes);
if (sizeOptions.length === 0 && product.productType === 'clothing') {
    sizeOptions = ['Small', 'Medium', 'Large', 'XL', '2XL', '3XL'];
}
const filterSizes = formattedSizes;
---

<article
    aria-label={product.title}
    class="flex flex-col justify-between"
    data-product-type={product.productType}
    data-sizes={filterSizes}
>
    <div class="relative">
        <!-- Size data for filtering - visible to screen readers but accessible to JS -->
        <span class="sr-only size-data">{filterSizes}</span>

        <div class="relative w-full overflow-hidden rounded-lg h-[500px]">
            <Lightbox image={product.images[0].url} title={product.title} />
        </div>
        <div class="relative mt-4 space-y-3">
            <h3 class="text-lg font-medium font-body text-replicant-100">{product.title}</h3>
            <div class="flex gap-2 items-center">
                <p
                    class="relative text-lg font-semibold line-through opacity-70 text-replicant-100 text-shadow"
                >
                    ${product.price}.00
                </p>
                <p class="relative text-lg font-semibold text-primary text-shadow">
                    ${salePrice}
                </p>
            </div>
            <p class="mt-2 text-replicant-300 sm:line-clamp-3">
                {product.description}
            </p>
            {
                product.sizes && (
                    <p class="mt-1 text-sm italic text-secondary size-display">
                        Available sizes: {formattedSizes}
                    </p>
                )
            }
        </div>
    </div>
    <div class="mt-6">
        <button
            class="flex relative justify-center items-center px-8 py-2 text-sm font-medium rounded-md border border-transparent transition-all duration-200 snipcart-add-item bg-replicant-200 text-replicant-900 hover:bg-replicant-400"
            data-item-id={product.id}
            data-item-price={salePrice}
            data-item-url="/shop/sale/"
            data-item-description={product.description}
            data-item-image={product.images[0].url}
            data-item-name={product.title}
            data-item-weight={product.productWeight}
            data-item-custom1-name={sizeOptions.length > 0 ? 'Size' : null}
            data-item-custom1-options={sizeOptions.length > 0 ? sizeOptions.join(' | ') : null}
        >
            Add to bag
        </button>
    </div>
</article>

<style>
    .text-shadow {
        text-shadow: 0 2px 2px rgba(0, 0, 0, 0.6);
    }

    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
    }

    .size-display {
        letter-spacing: 0.055em;
    }

    .size-display :global(.dot) {
        margin: 0 0.25rem;
        opacity: 0.7;
    }
</style>

---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PageHero from '../../components/PageHero.astro';
import SectionIntro from '../../components/SectionIntro.astro';
import PromoBanner from '../../components/PromoBanner.astro';

import { Image } from 'astro:assets';
import { getCollection } from 'astro:content';

const allReleases = await getCollection('discography');

// Resolve cover images
const coverImages = import.meta.glob<{ default: ImageMetadata }>(
    '/src/assets/discography/*.{jpg,jpeg,png,webp}',
    { eager: true },
);

function getCover(filename: string) {
    const path = `/src/assets/discography/${filename}`;
    return coverImages[path]?.default;
}

// Split into albums and EPs/splits, sorted by date descending
const albums = allReleases
    .filter((r) => r.data.releaseType === 'Full Length')
    .sort((a, b) => b.data.datePublished.localeCompare(a.data.datePublished));

const eps = allReleases
    .filter((r) => r.data.releaseType !== 'Full Length')
    .sort((a, b) => b.data.datePublished.localeCompare(a.data.datePublished));

// Build JSON-LD album entries from collection data
function buildAlbumJsonLd(release: (typeof allReleases)[number]) {
    const d = release.data;
    const byArtist = d.additionalArtists?.length
        ? [
              { '@type': 'MusicGroup', '@id': 'https://replicant.band/#band' },
              ...d.additionalArtists.map((name) => ({ '@type': 'MusicGroup', name })),
          ]
        : { '@type': 'MusicGroup', '@id': 'https://replicant.band/#band' };

    const cover = getCover(d.cover);
    const entry: Record<string, unknown> = {
        '@type': 'MusicAlbum',
        name: d.title,
        albumProductionType: 'https://schema.org/StudioAlbum',
        albumReleaseType: `https://schema.org/${d.albumReleaseType}`,
        datePublished: d.datePublished,
        numTracks: d.numTracks,
        image: cover?.src ? new URL(cover.src, 'https://replicant.band').href : undefined,
        byArtist,
        recordLabel: { '@type': 'Organization', name: d.label },
    };

    if (d.tracks?.length) {
        entry.track = {
            '@type': 'ItemList',
            numberOfItems: d.numTracks,
            itemListElement: d.tracks.map((t, i) => ({
                '@type': 'ListItem',
                position: i + 1,
                item: { '@type': 'MusicRecording', name: t.name },
            })),
        };
    }

    return entry;
}
---

<Fragment slot="head">
    <script
        type="application/ld+json"
        set:html={JSON.stringify({
            '@context': 'https://schema.org',
            '@type': 'CollectionPage',
            name: 'Replicant Discography',
            description:
                'Full discography of Replicant, a dissonant death metal band from New Jersey. Albums, EPs, and splits from 2016 to present.',
            url: 'https://replicant.band/discography/',
            mainEntity: {
                '@type': 'MusicGroup',
                '@id': 'https://replicant.band/#band',
                album: [...albums, ...eps].map(buildAlbumJsonLd),
            },
        })}
    />
    <script
        type="application/ld+json"
        set:html={JSON.stringify({
            '@context': 'https://schema.org',
            '@type': 'BreadcrumbList',
            itemListElement: [
                {
                    '@type': 'ListItem',
                    position: 1,
                    name: 'Home',
                    item: 'https://replicant.band/',
                },
                {
                    '@type': 'ListItem',
                    position: 2,
                    name: 'Discography',
                },
            ],
        })}
    />
</Fragment>

<BaseLayout
    title="Discography | Replicant"
    desc="Official discography of Replicant. Includes all albums, singles, and EP releases."
>
    <main class="py-10 lg:py-16">
        <PageHero />
        <section class="mt-32">
            <SectionIntro title="Full Lengths" />
            <div class="container px-6 mx-auto mt-24 xl:px-0">
                <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
                    {
                        albums.map((album) => {
                            const cover = getCover(album.data.cover);
                            return cover ? (
                                <div>
                                    <Image
                                        src={cover}
                                        alt={`${album.data.title} Album Cover`}
                                        width={496}
                                        height={496}
                                        format="avif"
                                    />
                                    <div class="flex flex-col gap-1 mt-4">
                                        <h2 class="text-3xl font-bold text-white">
                                            {album.data.title}
                                        </h2>
                                        <span class="text-replicant-300">
                                            {album.data.releaseDate}
                                        </span>
                                        <a
                                            href={`/discography/${album.data.slug}`}
                                            class="text-primary hover:underline"
                                        >
                                            View Album
                                        </a>
                                    </div>
                                </div>
                            ) : null;
                        })
                    }
                </div>
            </div>
        </section>
        <section class="mt-32">
            <SectionIntro title="EPs / Splits" />
            <div class="container px-6 mx-auto mt-24 xl:px-0">
                <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
                    {
                        eps.map((ep) => {
                            const cover = getCover(ep.data.cover);
                            return cover ? (
                                <div>
                                    <Image
                                        src={cover}
                                        alt={`${ep.data.title} Cover`}
                                        width={496}
                                        height={496}
                                        format="avif"
                                    />
                                    <div class="flex flex-col gap-1 mt-4">
                                        <h2 class="text-3xl font-bold text-white">
                                            {ep.data.title}
                                        </h2>
                                        <span class="text-replicant-300">
                                            {ep.data.releaseDate}
                                        </span>
                                        <a
                                            href={`/discography/${ep.data.slug}`}
                                            class="text-primary hover:underline"
                                        >
                                            View Release
                                        </a>
                                    </div>
                                </div>
                            ) : null;
                        })
                    }
                </div>
            </div>
        </section>
        <section class="mt-32">
            <PromoBanner />
        </section>
    </main>
</BaseLayout>

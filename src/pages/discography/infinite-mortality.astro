---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { Image } from 'astro:assets';
import imCover from '../../assets/discography/im-cover-hi-res.jpg';
import AudioPlayer from '../../components/AudioPlayer.svelte';

const title = 'Infinite Mortality | Replicant Discography';
const desc =
    'Infinite Mortality — the third full-length album from Replicant. Nine tracks of dissonant, technical death metal. Released April 12, 2024 via Transcending Obscurity Records. Available on vinyl, CD, cassette, and digital.';

const audioBase = 'https://res.cloudinary.com/observatory-team/video/upload';

const tracks = [
    { num: '01', name: 'Acid Mirror', duration: '6:37', src: `${audioBase}/acid-mirror.mp3` },
    {
        num: '02',
        name: 'Shrine to the Incomprehensible',
        duration: '5:59',
        src: `${audioBase}/shrine-to-the-incomprehensible.mp3`,
    },
    {
        num: '03',
        name: 'Orgasm of Bereavement',
        duration: '3:31',
        src: `${audioBase}/orgasm-of-bereavement.mp3`,
    },
    {
        num: '04',
        name: 'Reciprocal Abandonment',
        duration: '6:03',
        src: `${audioBase}/reciprocal-abandonment.mp3`,
    },
    { num: '05', name: 'SCN9A', duration: '1:01', src: `${audioBase}/scn9a.mp3` },
    { num: '06', name: 'Pain Enduring', duration: '4:50', src: `${audioBase}/pain-enduring.mp3` },
    { num: '07', name: 'Nekrotunnel', duration: '4:07', src: `${audioBase}/nekrotunnel.mp3` },
    {
        num: '08',
        name: 'Dwelling on the Threshold',
        duration: '2:48',
        src: `${audioBase}/dwelling-on-the-threshold.mp3`,
    },
    { num: '09', name: 'Planet of Skin', duration: '9:11', src: `${audioBase}/planet-of-skin.mp3` },
];

// Fetch products from the CMS and filter for this release
import { getSizeOptions } from '../../utils/sizes';

interface AlbumProduct {
    slug: string;
    id: string;
    title: string;
    description: string;
    price: number;
    image: { url: string; secure_url?: string };
    productType: string;
    productWeight: number;
    fileGuid: string;
    sale?: boolean;
    sizes?: string;
}

let albumProducts: AlbumProduct[] = [];

try {
    const result = await fetch(import.meta.env.PUBLIC_GRAPHCMS_API, {
        headers: { 'Content-Type': 'application/json' },
        method: 'POST',
        body: JSON.stringify({
            query: `query {
                products {
                    slug
                    id
                    title
                    description
                    price
                    image
                    productType
                    productWeight
                    fileGuid
                    sale
                    sizes
                }
            }`,
        }),
    });
    if (result.ok) {
        const json = await result.json();
        const allProducts: AlbumProduct[] = json.data.products;

        // Filter for Infinite Mortality products (vinyl, CD, digital)
        albumProducts = allProducts.filter((p) =>
            p.title.toLowerCase().includes('infinite mortality'),
        );

        // Normalize Cloudinary URLs to AVIF
        albumProducts.forEach((p) => {
            if (p.image) {
                const raw = p.image.secure_url || p.image.url;
                if (raw?.includes('res.cloudinary.com')) {
                    p.image.url = raw
                        .replace('/upload/', '/upload/f_avif,q_auto/')
                        .replace(/\.(png|jpg|jpeg|webp)$/i, '.avif');
                } else if (raw) {
                    p.image.url = raw;
                }
            }
        });
    }
} catch {
    // Graceful fallback — section will show empty if CMS is unreachable
}

const reviews = [
    {
        quote: 'The simple truth is that Replicant have me head over heels for Infinite Mortality. It’s brutal, it’s smart as hell, and it’s a novel entry in the wild world of skronky death. You’d be remiss to let it pass you by.',
        source: 'Angry Metal Guy',
        link: 'https://www.angrymetalguy.com/replicant-infinite-mortality-review/',
    },
    {
        quote: 'Nobody out there sounds like Replicant, and Replicant is officially at the top of their game. Infinite Mortality is their best work so far, an enormous destructive machine dripping blood and oil that will crush you between its horrible steel jaws. It’s focused, quirky, and hideous as can be, filled with groove that’s more infectious than the plague. Get this one in your ears ASAP.',
        source: 'Noob Heavy',
        link: 'https://noobheavy.com/album-review-replicant-infinite-mortality/',
    },
];

const musicVideos = [
    { id: 'Je2jQai2D0s', track: 'Nekrotunnel' },
    { id: 'UdNUn8hgd1Y', track: 'Orgasm of Bereavement' },
];

const lineup = [
    { name: 'Michael Gonçalves', role: 'Vocals, Bass, Guitars' },
    { name: 'Peter Lloyd', role: 'Guitars, Synths' },
    { name: 'Itay Keren', role: 'Guitars, Vocals' },
    { name: 'James Applegate', role: 'Drums' },
];

const credits = [
    {
        label: 'Recording',
        text: 'Recorded across New Jersey, Pennsylvania, and New York between January and July 2023.',
    },
    {
        label: 'Engineering & Mix',
        text: 'Mixed, mastered and drums engineered by AJ Viana.',
    },
    { label: 'Artwork', text: 'Alli Tuttle' },
    { label: 'Guest Appearances', text: '-' },
];
---

<BaseLayout title={title} desc={desc}>
    <Fragment slot="head">
        <script
            type="application/ld+json"
            set:html={JSON.stringify({
                '@context': 'https://schema.org',
                '@type': 'MusicAlbum',
                name: 'Infinite Mortality',
                albumProductionType: 'https://schema.org/StudioAlbum',
                albumReleaseType: 'https://schema.org/AlbumRelease',
                datePublished: '2024-04-12',
                numTracks: 9,
                url: 'https://replicant.band/discography/infinite-mortality/',
                image: 'https://replicant.band/_astro/im-cover.C3yB7JfE_G5HpW.avif',
                byArtist: { '@type': 'MusicGroup', '@id': 'https://replicant.band/#band' },
                recordLabel: { '@type': 'Organization', name: 'Transcending Obscurity Records' },
                track: {
                    '@type': 'ItemList',
                    numberOfItems: 9,
                    itemListElement: tracks.map((t, i) => ({
                        '@type': 'ListItem',
                        position: i + 1,
                        item: { '@type': 'MusicRecording', name: t.name },
                    })),
                },
            })}
        />
    </Fragment>

    <main>
        <!-- HERO -->
        <section class="relative lg:min-h-screen grid grid-cols-1 lg:grid-cols-2 overflow-hidden">
            <!-- Left: text content -->
            <div
                class="relative flex items-center px-6 lg:px-16 pt-28 pb-16 lg:pt-0 lg:pb-0 animate-[fadeUp_0.8s_ease-out_both]"
            >
                <div
                    class="pointer-events-none absolute inset-0"
                    style="background: radial-gradient(ellipse at 30% 50%, rgba(218,146,82,0.06) 0%, transparent 60%);"
                >
                </div>
                <div class="relative z-[1] max-w-xl">
                    <div
                        class="flex items-center gap-3 mb-6 text-sm font-bold tracking-[0.2em] uppercase text-primary"
                    >
                        <span class="w-6 h-px bg-primary"></span>
                        Full Length · 2024
                    </div>
                    <h1
                        class="text-5xl lg:text-7xl font-bold tracking-tight mb-4 text-replicant-200"
                    >
                        Infinite Mortality
                    </h1>

                    <div class="flex flex-wrap gap-8 mt-8">
                        <div class="flex flex-col gap-0.5">
                            <span
                                class="text-[0.6rem] font-bold tracking-[0.15em] uppercase text-replicant-500"
                                >Released</span
                            >
                            <span class="text-sm text-replicant-200">April 12, 2024</span>
                        </div>
                        <div class="flex flex-col gap-0.5">
                            <span
                                class="text-[0.6rem] font-bold tracking-[0.15em] uppercase text-replicant-500"
                                >Label</span
                            >
                            <span class="text-sm text-replicant-200"
                                >Transcending Obscurity Records</span
                            >
                        </div>
                        <div class="flex flex-col gap-0.5">
                            <span
                                class="text-[0.6rem] font-bold tracking-[0.15em] uppercase text-replicant-500"
                                >Format</span
                            >
                            <span class="text-sm text-replicant-200"
                                >Vinyl · CD · Cassette · Digital</span
                            >
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-4 mt-12">
                        <a
                            href="#buy"
                            class="inline-flex items-center rounded-sm gap-2 px-8 py-3.5 bg-primary text-replicant-900 text-sm font-bold tracking-[0.15em] uppercase no-underline transition-all duration-300 hover:bg-primary-dark hover:shadow-[0_0_30px_rgba(218,146,82,0.3)] hover:-translate-y-px"
                        >
                            ⚔️ Buy Some Merch ⚔️
                        </a>
                        <a
                            href="#listen"
                            class="inline-flex items-center rounded-sm gap-2 px-8 py-3.5 border border-replicant-700 text-replicant-200 text-sm font-bold tracking-[0.15em] uppercase no-underline transition-all duration-300 hover:border-replicant-400 hover:bg-white/[0.03]"
                        >
                            Stream Album
                        </a>
                    </div>
                </div>
            </div>

            <!-- Right: album art, edge-to-edge -->
            <div
                class="relative min-h-[400px] lg:min-h-0 animate-[fadeUp_0.8s_ease-out_0.15s_both]"
            >
                <Image
                    src={imCover}
                    alt="Infinite Mortality Album Cover"
                    width={1800}
                    height={1800}
                    quality={80}
                    format="avif"
                    class="absolute inset-0 w-full h-full object-cover"
                />
            </div>
        </section>

        <!-- TRACKLIST -->
        <AudioPlayer {tracks} client:load />

        <!-- ABOUT -->
        <section class="fade-in px-6 lg:px-16 py-16 lg:py-20 border-t border-replicant-700">
            <div class="container mx-auto">
                <div
                    class="flex items-center gap-4 mb-10 text-xs uppercase font-bold tracking-[0.25em] text-replicant-500"
                >
                    Album Details
                    <span class="flex-1 h-px bg-replicant-700"></span>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-[2fr_1fr] gap-8 lg:gap-16 items-start">
                    <div class="text-base leading-relaxed text-replicant-400 max-w-2xl">
                        After having smashed prevailing standards for the style with their unique
                        approach on their highly lauded previous release, Replicant take things
                        further still with their third full length, finding ways to make their music <span
                            class="text-replicant-200">even more convoluted and impactful</span
                        > while retaining their trademark dissonant and catchy sound. They've found ways
                        to add new aspects to it without hampering the momentum, constantly changing
                        things up with the listener's body still lashing uncontrollably. The songs veer
                        off in their own unexpected, thrilling directions while upholding the inherent
                        semblance of groove, only to reconnect later with greater force. Things seem
                        to add up and make sense as the album progresses — an ostensibly innocuous mechanical
                        contraption getting constant upgrades to become potentially world-ending. There's
                        fire in the songwriting, the members refusing to succumb to the lull of complacency
                        and working furiously, constantly on the songs to elevate them to a rarefied
                        category.
                    </div>
                    <div class="flex flex-col gap-6">
                        <div class="p-6 bg-replicant-900 border border-replicant-700">
                            <h2
                                class="text-[0.6rem] font-bold tracking-[0.2em] uppercase text-replicant-500 mb-4"
                            >
                                Lineup
                            </h2>
                            <ul class="flex flex-col gap-2 list-none">
                                {
                                    lineup.map((member) => (
                                        <li>
                                            <span class="text-sm font-medium text-replicant-200">
                                                {member.name}
                                            </span>
                                            <span class="text-sm text-replicant-500">
                                                {' '}
                                                — {member.role}
                                            </span>
                                        </li>
                                    ))
                                }
                            </ul>
                        </div>
                        <div class="p-6 bg-replicant-900 border border-replicant-700">
                            <h2
                                class="text-[0.6rem] font-bold tracking-[0.2em] uppercase text-replicant-500 mb-4"
                            >
                                Credits
                            </h2>
                            <ul class="flex flex-col gap-2 list-none">
                                {
                                    credits.map((credit) => (
                                        <li>
                                            <span class="text-[0.6rem] font-bold tracking-[0.15em] uppercase text-replicant-500">
                                                {credit.label}
                                            </span>
                                            <p class="text-sm text-replicant-400">{credit.text}</p>
                                        </li>
                                    ))
                                }
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- PRESS -->
        <section class="fade-in px-6 lg:px-16 py-16 lg:py-20 border-t border-replicant-700">
            <div class="container mx-auto">
                <div
                    class="flex items-center gap-4 mb-10 text-xs uppercase font-bold tracking-[0.25em] text-replicant-500"
                >
                    Press
                    <span class="flex-1 h-px bg-replicant-700"></span>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-24">
                    {
                        reviews.map((review) => (
                            <a href={review.link} target="_blank" rel="noopener noreferrer">
                                <blockquote class="border-l-2 border-primary pl-6">
                                    <p class="text-lg italic text-replicant-300 leading-relaxed mb-3">
                                        &ldquo;{review.quote}&rdquo;
                                    </p>
                                    <cite class="text-[0.7rem] font-bold tracking-[0.15em] uppercase text-replicant-500 not-italic">
                                        {review.source}
                                    </cite>
                                </blockquote>
                            </a>
                        ))
                    }
                </div>
            </div>
        </section>

        <!-- BUY -->
        <section
            id="buy"
            class="fade-in px-6 lg:px-16 py-16 lg:py-20 border-t border-replicant-700 bg-[#111]"
        >
            <div class="container mx-auto">
                <div
                    class="flex items-center gap-4 mb-10 text-xs uppercase font-bold tracking-[0.25em] text-replicant-500"
                >
                    Buy
                    <span class="flex-1 h-px bg-replicant-700"></span>
                </div>
                {
                    albumProducts.length > 0 ? (
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                            {albumProducts.map((product) => (
                                <div class="border border-replicant-700 bg-replicant-900 flex flex-col transition-all duration-300 hover:border-primary hover:-translate-y-0.5">
                                    {product.image?.url && (
                                        <div class="overflow-hidden aspect-square">
                                            <img
                                                src={product.image.url}
                                                alt={product.title}
                                                class="w-full h-full object-cover"
                                                loading="lazy"
                                            />
                                        </div>
                                    )}
                                    <div class="p-6 flex flex-col gap-3 flex-1">
                                        <span class="text-[0.65rem] font-bold tracking-[0.15em] uppercase text-replicant-500">
                                            {product.productType}
                                        </span>
                                        <span class="text-lg font-semibold text-replicant-200">
                                            {product.title}
                                        </span>
                                        <p class="text-sm text-replicant-500 leading-relaxed line-clamp-3">
                                            {product.description}
                                        </p>
                                        <span class="text-lg font-bold text-primary mt-auto">
                                            $
                                            {product.sale
                                                ? (product.price * 0.8).toFixed(2)
                                                : `${product.price}.00`}
                                        </span>
                                        {(() => {
                                            const sizeOptions = getSizeOptions(
                                                product.sizes,
                                                product.productType,
                                                product.sale,
                                            );
                                            return (
                                                <button
                                                    class="snipcart-add-item inline-flex items-center justify-center py-3 bg-primary text-white text-[0.65rem] font-bold tracking-[0.15em] uppercase cursor-pointer transition-all duration-300 hover:bg-primary-dark border-none"
                                                    data-item-id={product.id}
                                                    data-item-price={
                                                        product.sale
                                                            ? (product.price * 0.8).toFixed(2)
                                                            : product.price
                                                    }
                                                    data-item-url="/discography/infinite-mortality/"
                                                    data-item-description={product.description}
                                                    data-item-image={product.image?.url}
                                                    data-item-name={product.title}
                                                    data-item-weight={product.productWeight}
                                                    {...(product.productType === 'digital'
                                                        ? {
                                                              'data-item-file-guid':
                                                                  product.fileGuid,
                                                              'data-item-shippable': 'false',
                                                          }
                                                        : {})}
                                                    {...(sizeOptions
                                                        ? {
                                                              'data-item-custom1-name': 'Size',
                                                              'data-item-custom1-options':
                                                                  sizeOptions,
                                                          }
                                                        : {})}
                                                >
                                                    Add to Cart &rarr;
                                                </button>
                                            );
                                        })()}
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <p class="text-replicant-500">No products available at this time.</p>
                    )
                }
            </div>
        </section>

        <!-- MUSIC VIDEOS -->
        <section class="fade-in px-6 lg:px-16 py-16 lg:py-20 border-t border-replicant-700">
            <div class="container mx-auto">
                <div
                    class="flex items-center gap-4 mb-10 text-xs uppercase font-bold tracking-[0.25em] text-replicant-500"
                >
                    Music Videos
                    <span class="flex-1 h-px bg-replicant-700"></span>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {
                        musicVideos.map((video) =>
                            video.id ? (
                                <div>
                                    <div class="aspect-video bg-replicant-900 border border-replicant-700">
                                        <iframe
                                            width="100%"
                                            height="100%"
                                            src={`https://www.youtube.com/embed/${video.id}`}
                                            title={`${video.track} — Replicant`}
                                            frameborder="0"
                                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                            allowfullscreen
                                        />
                                    </div>
                                    <p class="mt-3 text-sm text-replicant-400">{video.track}</p>
                                </div>
                            ) : (
                                <div>
                                    <div class="aspect-video bg-replicant-900 border border-replicant-700 flex flex-col items-center justify-center gap-3">
                                        <span class="text-3xl text-replicant-500">▶</span>
                                        <span class="text-[0.7rem] font-bold tracking-[0.15em] uppercase text-replicant-500">
                                            Drop video ID in frontmatter
                                        </span>
                                    </div>
                                    <p class="mt-3 text-sm text-replicant-500">{video.track}</p>
                                </div>
                            ),
                        )
                    }
                </div>
            </div>
        </section>

        <!-- DISCOGRAPHY NAV -->
        <!-- <section
            class="flex justify-between items-center px-6 lg:px-16 py-12 border-t border-replicant-700"
        >
            <a
                href="/discography/malignant-reality/"
                class="flex flex-col gap-1 no-underline transition-opacity duration-300 hover:opacity-70"
            >
                <span class="text-[0.6rem] font-bold tracking-[0.15em] uppercase text-replicant-500"
                    >&larr; Previous</span
                >
                <span class="text-lg text-replicant-200">Malignant Reality</span>
            </a>
            <a
                href="/discography/"
                class="hidden sm:inline-flex items-center gap-2 px-6 py-3 border border-replicant-700 text-replicant-200 text-[0.65rem] font-bold tracking-[0.15em] uppercase no-underline transition-all duration-300 hover:border-replicant-400 hover:bg-white/[0.03]"
            >
                All Releases
            </a>
            <div class="flex flex-col gap-1 text-right opacity-30 pointer-events-none">
                <span class="text-[0.6rem] font-bold tracking-[0.15em] uppercase text-replicant-500"
                    >Next &rarr;</span
                >
                <span class="text-lg text-replicant-200">&mdash;</span>
            </div>
        </section> -->
    </main>
</BaseLayout>

<style>
    @keyframes fadeUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .fade-in {
        opacity: 0;
        transform: translateY(16px);
        transition:
            opacity 0.6s ease-out,
            transform 0.6s ease-out;
    }

    .fade-in.visible {
        opacity: 1;
        transform: translateY(0);
    }
</style>

<script>
    const observer = new IntersectionObserver(
        (entries) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                }
            });
        },
        { threshold: 0.1 },
    );

    document.querySelectorAll('.fade-in').forEach((el) => observer.observe(el));
</script>
